hydra:
  searchpath:
    - file://verl/trainer/config

defaults:
  - ppo_trainer
  - _self_

data:
  max_prompt_length: 2048
  max_response_length: 2048
  train_batch_size: 256
  return_raw_chat: True
  return_multi_modal_inputs: False

actor_rollout_ref:
  hybrid_engine: True
  model:
    custom_chat_template: "{# Track number of images and videos #}\n{% set image_count = namespace(value=0) %}\n{% set video_count = namespace(value=0) %}\n\n{# If tools are present, add system tool declaration block #}\n{% if tools %}\n<|im_start|>system\n{% if messages[0]['role'] == 'system' %}\n    {% if messages['content'] is string %}\n{{ messages[0]['content'] }}\n    {% else %}\n        {% for content in messages['content'] %}\n            {% if 'text' in content %}\n{{ content['text'] }}\n            {% endif %}\n        {% endfor %}\n    {% endif %} \n{% else %}\nYou are a helpful assistant.\n{% endif %}\n\n# Tools\n\nYou may call one or more functions to assist with the user query.\n\nYou are provided with function signatures within <tools></tools> XML tags:\n<tools>\n{% for tool in tools %}\n{{ tool | tojson }}\n{% endfor %}\n</tools>\n\nFor each function call, return a json object with function name and arguments within <tool_call></tool_call> XML tags:\n<tool_call>\n{\"name\": <function-name>, \"arguments\": <args-json-object>}\n</tool_call>\n<|im_end|>\n{% endif %}\n\n{# Process message list #}\n{% for message in messages %}\n  {% set is_tool_call = message.role == \"assistant\" and message.tool_calls %}\n  {% set is_media_message = message['content'] is not string %}\n\n  {# SYSTEM fallback if no tools and first message isn't system #}\n  {% if loop.first and message['role'] != 'system' and not tools %}\n<|im_start|>system\nYou are a helpful assistant.\n<|im_end|>{%- elif loop.first and message['role'] == 'system' and not tools -%}{{- '<|im_start|>system\\n' -}}{{ message['content'] if message['content'] is string else (message['content'] | selectattr('type', 'equalto', 'text') | map(attribute='text') | join('')) }}\n<|im_end|>{% endif %} {# USER, SYSTEM (non-initial), ASSISTANT (no tool call) #}\n  {% if message.role in ['user', 'system'] and (message.role != 'system' or not loop.first) or (message.role == 'assistant' and not is_tool_call) %}\n<|im_start|>{{ message['role'] }}\n    {% if message['content'] is string %}\n{{ message['content'] }}<|im_end|>\n    {% else %}\n      {% for content in message['content'] %}\n        {% if content['type'] == 'image' or 'image' in content or 'image_url' in content %}\n          {% set image_count.value = image_count.value + 1 %}\n          {% if add_vision_id %}Picture {{ image_count.value }}: {% endif %}\n<|vision_start|><|image_pad|><|vision_end|>\n        {% elif content['type'] == 'video' or 'video' in content %}\n          {% set video_count.value = video_count.value + 1 %}\n          {% if add_vision_id %}Video {{ video_count.value }}: {% endif %}\n<|vision_start|><|video_pad|><|vision_end|>\n        {% elif 'text' in content %}\n{{ content['text'] }}\n        {% endif %}\n      {% endfor %}\n<|im_end|>\n    {% endif %}\n\n  {# ASSISTANT tool calls #}\n  {% elif message.role == 'assistant' and is_tool_call %}\n<|im_start|>assistant\n    {% if message.content %}\n{{ message.content }}\n    {% endif %}\n    {% for tool_call in message.tool_calls %}\n      {% set tool_call = tool_call.function if tool_call.function is defined else tool_call %}\n<tool_call>\n{\"name\": \"{{ tool_call.name }}\", \"arguments\": {{ tool_call.arguments | tojson }}}\n</tool_call>\n    {% endfor %}\n<|im_end|>\n\n  {# TOOL response #}\n  {% elif message.role == 'tool' %}\n    {% if loop.index0 == 0 or messages[loop.index0 - 1].role != 'tool' %}\n<|im_start|>user\n    {% endif %}\n<tool_response>\n    {% if message['content'] is string %}\n{{ message.content }}\n    {% else %}\n      {% for content in message['content'] %}\n        {% if content['type'] == 'image' or 'image' in content or 'image_url' in content %}\n          {% set image_count.value = image_count.value + 1 %}\n          {% if add_vision_id %}Picture {{ image_count.value }}: {% endif %}\n<|vision_start|><|image_pad|><|vision_end|>\n        {% elif content['type'] == 'video' or 'video' in content %}\n          {% set video_count.value = video_count.value + 1 %}\n          {% if add_vision_id %}Video {{ video_count.value }}: {% endif %}\n<|vision_start|><|video_pad|><|vision_end|>\n        {% elif content['type'] == 'text' or 'text' in content %}\n{{ content['text'] }}\n        {% endif %}\n      {% endfor %}\n    {% endif %}\n</tool_response>\n    {% if loop.last or messages[loop.index0 + 1].role != 'tool' %}\n<|im_end|>\n    {% endif %}\n  {% endif %}\n{% endfor %}\n\n{# Add trailing assistant prompt if required #}\n{% if add_generation_prompt %}\n<|im_start|>assistant\n{% endif %}\n"
  rollout:
    name: sglang
    multi_turn:
      enable: True
      max_assistant_turns: 5
      max_tool_call: 5
      #tokenization_sanity_check_mode: disable     #bug in ray
      # tool_config_path: "./config/tool_config/gsm8k_tool_config.yaml"
